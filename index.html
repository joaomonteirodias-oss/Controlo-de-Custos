<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Custos de Obra</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Initial Modal -->
  <div id="initialModal" class="modal">
    <div class="modal-content">
      <h2>üèóÔ∏è Sistema de Gest√£o de Custos</h2>
      <p style="text-align: center; margin-bottom: 30px; color: var(--color-text-secondary);">
        Bem-vindo! Escolha uma op√ß√£o para come√ßar:
      </p>
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <button class="btn btn--primary" onclick="createNewDatabase()" style="padding: 20px;">
          ‚ûï Criar Nova Base de Dados
        </button>
        <button class="btn btn--secondary" onclick="document.getElementById('loadDbFile').click()" style="padding: 20px;">
          üìÇ Carregar Base de Dados Existente
        </button>
      </div>
      <input type="file" id="loadDbFile" accept=".xlsx,.xls" style="display:none" onchange="loadDatabaseFromFile()">
    </div>
  </div>

  <!-- Project Modal -->
  <div id="projectModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-height: 90vh; overflow-y: auto; max-width: 700px;">
      <h2>üè≠ Informa√ß√µes do Projecto</h2>
      <form id="projectForm">
        <h3 style="color: #21808d; margin-top: 25px; margin-bottom: 15px;">üìã PROJECTO</h3>
        <div class="form-group">
          <label for="projectName" class="form-label">Nome do Projecto *</label>
          <input type="text" id="projectName" class="form-control" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="projectOwner" class="form-label">Dono de Obra</label>
            <input type="text" id="projectOwner" class="form-control">
          </div>
          <div class="form-group">
            <label for="projectArchitect" class="form-label">Arquitecto</label>
            <input type="text" id="projectArchitect" class="form-control">
          </div>
          <div class="form-group">
            <label for="projectObraNumero" class="form-label">N√∫mero da Obra (2 d√≠gitos) *</label>
            <input type="text" id="projectObraNumero" class="form-control" maxlength="2" placeholder="Ex: 01, 15, 99" required>
          </div>
        </div>

        <h3 style="color: #21808d; margin-top: 25px; margin-bottom: 15px;">üè¢ NOSSA EMPRESA</h3>
        <div class="form-group">
          <label for="empresaNome" class="form-label">Nome da Empresa *</label>
          <input type="text" id="empresaNome" class="form-control" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="empresaNIF" class="form-label">NIF *</label>
            <input type="text" id="empresaNIF" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="empresaMorada" class="form-label">Morada *</label>
            <input type="text" id="empresaMorada" class="form-control" required>
          </div>
        </div>

        <h3 style="color: #21808d; margin-top: 25px; margin-bottom: 15px;">üë• CLIENTE</h3>
        <div class="form-group">
          <label for="clienteNome" class="form-label">Nome do Cliente *</label>
          <input type="text" id="clienteNome" class="form-control" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clienteNIF" class="form-label">NIF *</label>
            <input type="text" id="clienteNIF" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="clienteMorada" class="form-label">Morada *</label>
            <input type="text" id="clienteMorada" class="form-control" required>
          </div>
        </div>

        <button type="submit" class="btn btn--primary btn--full-width" style="margin-top: 25px;">Confirmar e Iniciar Projecto</button>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="header" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-24) var(--space-32);">
    <div style="display: flex; align-items: center; gap: 20px;">
      <!-- ‚úÖ LOGO PLACER (ficheiro local com fallback) -->
      <img src="./Logotipo-Placer_PB.jpg" alt="Placer Logo" style="height: 50px; width: auto;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 200 60%27%3E%3Ctext x=%2710%27 y=%2740%27 font-size=%2732%27 font-weight=%27bold%27 fill=%27%233F4242%27 font-family=%27Arial, sans-serif%27%3EPLACER%3C/text%3E%3C/svg%3E'">
      <div>
        <h1 id="projectTitle" style="margin: 0; font-size: 24px;">Gest√£o de Custos de Obra</h1>
        <p id="projectSubtitle" style="margin: 5px 0 0 0; color: var(--color-text-secondary); font-size: var(--font-size-base);">Obra: <span id="projectObraDisplay">--</span></p>
      </div>
    </div>

  </header>

  <!-- Tabs Navigation -->
  <nav class="tabs-nav">
    <button class="tab-btn active" data-tab="contrato">Contrato</button>
    <button class="tab-btn" data-tab="fornecedores">Fornecedores</button>
    <button class="tab-btn" data-tab="custos">Custos</button>
    <button class="tab-btn" data-tab="producao">Produ√ß√£o</button>
    <button class="tab-btn" data-tab="encomendas">üìù Encomendas</button>
    <button class="tab-btn" data-tab="posicao">Posi√ß√£o</button>
    <button class="tab-btn" data-tab="detalhes-tabelas">Detalhes (Tabelas)</button>
    <button class="tab-btn" data-tab="detalhes-graficos">Detalhes (Gr√°ficos)</button>
    <button class="tab-btn" data-tab="relatorios">Relat√≥rios</button>
    <button class="tab-btn" data-tab="importar-exportar">Importar/Exportar</button>
  </nav>

  <!-- Tab Content -->
  <div class="container">
    <!-- CONTRATO TAB -->
    <div id="tab-contrato" class="tab-content active">
      <div class="dashboard-grid">
        <div class="card dashboard-card">
          <div class="card-label">Venda Contratual</div>
          <div class="card-value" id="dashVendaContratual">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Custos Previstos</div>
          <div class="card-value" id="dashCustosPrevistos">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Trabalhos Adicionais</div>
          <div class="card-value" id="dashTrabalhosAdicionais">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Venda Total</div>
          <div class="card-value" id="dashVendaTotal">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Custo Total</div>
          <div class="card-value" id="dashCustoTotal">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Margem Bruta ‚Ç¨</div>
          <div class="card-value" id="dashMargemBruta">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Margem Bruta %</div>
          <div class="card-value" id="dashMargemBrutaPct">0.0%</div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Contrato Principal</h3>
          <form id="contractForm">
            <div class="form-row">
              <div class="form-group">
                <label for="initialSale" class="form-label">Venda Inicial (Contratual) ‚Ç¨</label>
                <input type="number" id="initialSale" class="form-control" step="0.01">
              </div>
              <div class="form-group">
                <label for="initialCost" class="form-label">Custo Inicial ‚Ç¨</label>
                <input type="number" id="initialCost" class="form-control" step="0.01">
              </div>
              <div class="form-group">
                <label for="durationMonths" class="form-label">Dura√ß√£o (meses)</label>
                <input type="number" id="durationMonths" class="form-control" value="12">
              </div>
              <div class="form-group">
                <label for="startDate" class="form-label">Data de In√≠cio</label>
                <input type="date" id="startDate" class="form-control">
              </div>
            </div>
            <button type="submit" class="btn btn--primary">Guardar Contrato</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Reor√ßamentos</h3>
          <form id="budgetForm">
            <div class="form-row">
              <div class="form-group">
                <label for="budgetDate" class="form-label">Data</label>
                <input type="date" id="budgetDate" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="budgetCost" class="form-label">Custo ‚Ç¨</label>
                <input type="number" id="budgetCost" class="form-control" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="budgetNotes" class="form-label">Notas</label>
                <input type="text" id="budgetNotes" class="form-control">
              </div>
            </div>
            <button type="submit" class="btn btn--primary">Adicionar Reor√ßamento</button>
          </form>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Custo</th>
                  <th>Notas</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="budgetsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>üìä Reor√ßamentos (Hist√≥rico Completo)</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Descri√ß√£o</th>
                  <th>Venda Total ‚Ç¨</th>
                  <th>Custo Total ‚Ç¨</th>
                  <th>Margem %</th>
                </tr>
              </thead>
              <tbody id="orcamentosTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>‚ûï Contratos Adicionais</h3>
          <form id="additionalContractForm">
            <div class="form-row">
              <div class="form-group">
                <label for="addContractName" class="form-label">Nome</label>
                <input type="text" id="addContractName" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="addContractSale" class="form-label">Venda ‚Ç¨</label>
                <input type="number" id="addContractSale" class="form-control" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="addContractCost" class="form-label">Custo ‚Ç¨</label>
                <input type="number" id="addContractCost" class="form-control" step="0.01" required>
              </div>
            </div>
            <button type="submit" class="btn btn--primary">Adicionar Contrato</button>
          </form>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Venda</th>
                  <th>Custo</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="additionalContractsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- FORNECEDORES TAB -->
    <div id="tab-fornecedores" class="tab-content">
      <div class="dashboard-grid-3">
        <div class="card dashboard-card">
          <div class="card-label">Custo Previsto</div>
          <div class="card-value" id="dashCustoPrevisto">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Contratado</div>
          <div class="card-value" id="dashTotalContratado">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card" id="dashDiferencaCard">
          <div class="card-label">Diferen√ßa</div>
          <div class="card-value" id="dashDiferenca">‚Ç¨0.00</div>
        </div>
      </div>

      <div class="card" id="supplierFormCard">
        <div class="card__body">
          <h3>Fornecedor</h3>
          <form id="supplierForm">
            <input type="hidden" id="editingSupplierId">
            <div class="form-row">
              <div class="form-group">
                <label for="supplierName" class="form-label">Nome *</label>
                <input type="text" id="supplierName" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="supplierNIF" class="form-label">NIF *</label>
                <input type="text" id="supplierNIF" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="supplierContact" class="form-label">Contacto</label>
                <input type="text" id="supplierContact" class="form-control">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="supplierCategory" class="form-label">Categoria *</label>
                <select id="supplierCategory" class="form-control" required>
                  <option value="">Seleccionar...</option>
                  <option value="Materiais">Materiais</option>
                  <option value="Sub-Empreiteiro">Sub-Empreiteiro</option>
                  <option value="M√£o-de-Obra">M√£o-de-Obra</option>
                  <option value="Estaleiro">Estaleiro</option>
                  <option value="Licen√ßas">Licen√ßas</option>
                  <option value="Conting√™ncias">Conting√™ncias</option>
                </select>
              </div>
              <div class="form-group">
                <label for="supplierContractValue" class="form-label">Valor Contrato ‚Ç¨</label>
                <input type="number" id="supplierContractValue" class="form-control" step="0.01">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn--primary" id="supplierSubmitBtn">Adicionar Fornecedor</button>
              <button type="button" class="btn btn--secondary" id="supplierCancelBtn" style="display:none;">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Lista de Fornecedores</h3>
          <div class="search-bar">
            <input type="text" id="supplierSearch" class="form-control" placeholder="Pesquisar fornecedor...">
            <select id="filterSupplierCategory" class="form-control" style="max-width: 200px;">
              <option value="">Todas as Categorias</option>
              <option value="Materiais">Materiais</option>
              <option value="Sub-Empreiteiro">Sub-Empreiteiro</option>
              <option value="M√£o-de-Obra">M√£o-de-Obra</option>
              <option value="Estaleiro">Estaleiro</option>
              <option value="Licen√ßas">Licen√ßas</option>
              <option value="Conting√™ncias">Conting√™ncias</option>
            </select>
            <button class="btn btn--secondary" onclick="filterSuppliers()">üîç Filtrar</button>
            <button class="btn btn--secondary" onclick="clearSupplierFilter()">‚úñ Limpar</button>
          </div>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>NIF</th>
                  <th>Contacto</th>
                  <th>Categoria</th>
                  <th>Contratado</th>
                  <th>Facturado</th>
                  <th>%</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="suppliersTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOS TAB -->
    <div id="tab-custos" class="tab-content">
      <div class="card">
        <div class="card__body">
          <h3>Nova Factura de Custo</h3>
          <form id="costInvoiceForm">
            <div class="form-row">
              <div class="form-group">
                <label for="costDate" class="form-label">Data *</label>
                <input type="date" id="costDate" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="costInvoiceNumber" class="form-label">N¬∫ Factura *</label>
                <input type="text" id="costInvoiceNumber" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="costDescription" class="form-label">Descri√ß√£o</label>
                <input type="text" id="costDescription" class="form-control">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="costSupplier" class="form-label">Fornecedor *</label>
                <select id="costSupplier" class="form-control" required>
                  <option value="">Seleccionar...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="costCategory" class="form-label">Categoria *</label>
                <select id="costCategory" class="form-control" required>
                  <option value="">Seleccionar...</option>
                  <option value="Materiais">Materiais</option>
                  <option value="Sub-Empreiteiro">Sub-Empreiteiro</option>
                  <option value="M√£o-de-Obra">M√£o-de-Obra</option>
                  <option value="Estaleiro">Estaleiro</option>
                  <option value="Licen√ßas">Licen√ßas</option>
                  <option value="Conting√™ncias">Conting√™ncias</option>
                </select>
                <small id="categoryLockNote" style="display:none; color: var(--color-text-secondary);">(categoria do fornecedor)</small>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="costValueNoVAT" class="form-label">Valor s/ IVA ‚Ç¨ *</label>
                <input type="number" id="costValueNoVAT" class="form-control" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="costValueWithVAT" class="form-label">Valor c/ IVA ‚Ç¨</label>
                <input type="number" id="costValueWithVAT" class="form-control" step="0.01">
              </div>
              <div class="form-group">
                <label for="costNotes" class="form-label">Notas</label>
                <input type="text" id="costNotes" class="form-control">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn--primary">Adicionar Factura</button>
              <button type="button" class="btn btn--secondary" onclick="importCostInvoicesExcel()">üì• Importar Excel</button>
              <input type="file" id="costExcelFile" accept=".xlsx,.xls" style="display:none;">
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Facturas de Custo</h3>
          <div class="search-bar">
            <input type="text" id="invoiceSearch" class="form-control" placeholder="Pesquisar factura...">
            <select id="filterCostCategory" class="form-control" style="max-width: 200px;">
              <option value="">Todas as Categorias</option>
              <option value="Materiais">Materiais</option>
              <option value="Sub-Empreiteiro">Sub-Empreiteiro</option>
              <option value="M√£o-de-Obra">M√£o-de-Obra</option>
              <option value="Estaleiro">Estaleiro</option>
              <option value="Licen√ßas">Licen√ßas</option>
              <option value="Conting√™ncias">Conting√™ncias</option>
            </select>
            <button class="btn btn--secondary" onclick="filterCostInvoices()">üîç Filtrar</button>
            <button class="btn btn--secondary" onclick="clearCostFilter()">‚úñ Limpar</button>
          </div>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>N¬∫ Factura</th>
                  <th>Descri√ß√£o</th>
                  <th>Categoria</th>
                  <th>Fornecedor</th>
                  <th>Valor s/ IVA</th>
                  <th>Valor c/ IVA</th>
                  <th>Notas</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="costInvoicesTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODU√á√ÉO TAB -->
    <div id="tab-producao" class="tab-content">
      <div class="card">
        <div class="card__body">
          <h3>Produ√ß√£o Mensal</h3>
          <form id="productionForm">
            <div class="form-row">
              <div class="form-group">
                <label for="productionMonth" class="form-label">M√™s *</label>
                <input type="month" id="productionMonth" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="productionContractual" class="form-label">Produ√ß√£o Contratual ‚Ç¨ *</label>
                <input type="number" id="productionContractual" class="form-control" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="productionAdditional" class="form-label">Produ√ß√£o Adicional ‚Ç¨</label>
                <input type="number" id="productionAdditional" class="form-control" step="0.01" value="0">
              </div>
            </div>
            <button type="submit" class="btn btn--primary">Adicionar Produ√ß√£o</button>
          </form>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>M√™s</th>
                  <th>Contratual</th>
                  <th>Adicional</th>
                  <th>Total</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="productionTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Nova Factura de Venda</h3>
          <form id="salesInvoiceForm">
            <div class="form-row">
              <div class="form-group">
                <label for="salesNumero" class="form-label">N¬∫ Factura *</label>
                <input type="text" id="salesNumero" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="salesDate" class="form-label">Data *</label>
                <input type="date" id="salesDate" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="salesDescription" class="form-label">Descri√ß√£o</label>
                <input type="text" id="salesDescription" class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo *</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="salesType" value="contratual" checked>
                  Contratual
                </label>
                <label>
                  <input type="radio" name="salesType" value="adicional">
                  Adicional
                </label>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="salesValueNoVAT" class="form-label">Valor s/ IVA ‚Ç¨ *</label>
                <input type="number" id="salesValueNoVAT" class="form-control" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="salesValueWithVAT" class="form-label">Valor c/ IVA ‚Ç¨</label>
                <input type="number" id="salesValueWithVAT" class="form-control" step="0.01">
              </div>
              <div class="form-group">
                <label for="salesNotes" class="form-label">Notas</label>
                <input type="text" id="salesNotes" class="form-control">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn--primary">Adicionar Factura</button>
              <button type="button" class="btn btn--secondary" onclick="importSalesInvoicesExcel()">üì• Importar Excel</button>
              <input type="file" id="salesExcelFile" accept=".xlsx,.xls" style="display:none;">
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Facturas de Venda</h3>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>N¬∫ Factura</th>
                  <th>Data</th>
                  <th>Descri√ß√£o</th>
                  <th>Tipo</th>
                  <th>Valor s/ IVA</th>
                  <th>Valor c/ IVA</th>
                  <th>Notas</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="salesInvoicesTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ENCOMENDAS TAB -->
    <div id="tab-encomendas" class="tab-content">
      <div class="card">
        <div class="card__body">
          <h3>üìù Nova Nota de Encomenda</h3>
          <p style="background: var(--color-bg-1); padding: 12px; border-radius: 6px; margin-bottom: 20px;">
            <strong>N√∫mero de Encomenda:</strong> Ser√° gerado automaticamente ao guardar (formato: <span id="previewNumero" style="color: var(--color-primary); font-family: monospace;">--</span>)
          </p>
          
          <div class="form-row">
            <div class="form-group">
              <label for="encomendaData" class="form-label">Data *</label>
              <input type="date" id="encomendaData" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="encomendaFornecedor" class="form-label">Fornecedor *</label>
              <select id="encomendaFornecedor" class="form-control" required>
                <option value="">Selecionar...</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="encomendaLocal" class="form-label">Local de Entrega *</label>
              <input type="text" id="encomendaLocal" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="encomendaFormaEntrega" class="form-label">Forma de Entrega</label>
              <input type="text" id="encomendaFormaEntrega" class="form-control">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="encomendaDataEntrega" class="form-label">Data de Entrega</label>
              <input type="date" id="encomendaDataEntrega" class="form-control">
            </div>
            <div class="form-group">
              <label for="encomendaContacto" class="form-label">Contacto</label>
              <input type="text" id="encomendaContacto" class="form-control">
            </div>
            <div class="form-group">
              <label for="encomendaTelemovel" class="form-label">Telem√≥vel</label>
              <input type="tel" id="encomendaTelemovel" class="form-control">
            </div>
          </div>
          
          <h4 style="margin-top: 30px; margin-bottom: 15px;">Artigos</h4>
          <div id="artigosContainer"></div>
          <button type="button" class="btn btn--secondary" onclick="addArtigoRow()" style="margin-bottom: 20px;">+ Adicionar Artigo</button>
          
          <div class="form-row">
            <div class="form-group">
              <label for="encomendaDescontoPerc" class="form-label">Desconto Comercial (%)</label>
              <input type="number" id="encomendaDescontoPerc" class="form-control" step="0.01" value="0" onchange="calculateEncomendaTotals()">
            </div>
            <div class="form-group">
              <label for="encomendaDescontoEuro" class="form-label">Desconto (‚Ç¨)</label>
              <input type="number" id="encomendaDescontoEuro" class="form-control" step="0.01" value="0" readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="encomendaTotalSemIVA" class="form-label">Total sem IVA ‚Ç¨</label>
              <input type="number" id="encomendaTotalSemIVA" class="form-control" readonly>
            </div>
            <div class="form-group">
              <label for="encomendaValorIVA" class="form-label">Valor do IVA (23%) ‚Ç¨</label>
              <input type="number" id="encomendaValorIVA" class="form-control" readonly>
            </div>
            <div class="form-group">
              <label for="encomendaTotalComIVA" class="form-label">Total com IVA ‚Ç¨</label>
              <input type="number" id="encomendaTotalComIVA" class="form-control" readonly>
            </div>
          </div>
          
          <div class="form-group">
            <label for="encomendaObservacoes" class="form-label">Observa√ß√µes / Condi√ß√µes de Pagamento</label>
            <textarea id="encomendaObservacoes" class="form-control" rows="3"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn--primary" onclick="saveEncomenda()">üíæ Guardar Encomenda</button>
            <button type="button" class="btn btn--primary" onclick="generateEncomendaPDF()" style="background-color: #10b981;">üìÑ Gerar PDF para Envio</button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card__body">
          <h3>üìã Notas de Encomenda Emitidas</h3>
          <div class="search-bar">
            <input type="text" id="searchEncomendas" class="form-control" placeholder="Pesquisar...">
            <select id="filterEncomendaFornecedor" class="form-control" style="max-width: 200px;">
              <option value="">Todos os Fornecedores</option>
            </select>
            <button class="btn btn--secondary" onclick="filterEncomendas()">üîç Filtrar</button>
            <button class="btn btn--secondary" onclick="clearEncomendaFilter()">‚úñ Limpar</button>
          </div>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>N¬∫ Encomenda</th>
                  <th>Data</th>
                  <th>Fornecedor</th>
                  <th>Local Entrega</th>
                  <th>Total s/ IVA ‚Ç¨</th>
                  <th>Total c/ IVA ‚Ç¨</th>
                  <th>Ac√ß√µes</th>
                </tr>
              </thead>
              <tbody id="encomendasTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- POSI√á√ÉO TAB -->
    <div id="tab-posicao" class="tab-content">
      <div class="dashboard-grid">
        <div class="card dashboard-card">
          <div class="card-label">Total Produzido Contratual</div>
          <div class="card-value" id="dashProduzidoContratual">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Saldo Contratual (por produzir)</div>
          <div class="card-value" id="dashSaldoContratual">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Produzido Adicional</div>
          <div class="card-value" id="dashProduzidoAdicional">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Saldo Adicional (por produzir)</div>
          <div class="card-value" id="dashSaldoAdicional">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Facturado</div>
          <div class="card-value" id="dashTotalFacturado">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Saldo (por facturar)</div>
          <div class="card-value" id="dashSaldoFacturar">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Margem Bruta %</div>
          <div class="card-value" id="dashMargemPosicao">0.0%</div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Produ√ß√£o Mensal</h3>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>M√™s</th>
                  <th>Prod. Mensal Contratual</th>
                  <th>Prod. Mensal Adicional</th>
                  <th>Prod. Total Mensal</th>
                  <th>Prod. Acum. Contratual</th>
                  <th>Prod. Acum. Adicional</th>
                  <th>Prod. Acum. Total</th>
                  <th>Saldo Contratual</th>
                  <th>Saldo Adicional</th>
                  <th>Saldo Total</th>
                </tr>
              </thead>
              <tbody id="positionProductionTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Factura√ß√£o Mensal</h3>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>M√™s</th>
                  <th>Fact. Mensal Contratual</th>
                  <th>Fact. Mensal Adicional</th>
                  <th>Fact. Total</th>
                  <th>Saldo Contratual</th>
                  <th>Saldo Adicional</th>
                  <th>Saldo Total</th>
                </tr>
              </thead>
              <tbody id="positionInvoicingTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- DETALHES TABELAS TAB -->
    <div id="tab-detalhes-tabelas" class="tab-content">
      <div class="dashboard-grid-4">
        <div class="card dashboard-card">
          <div class="card-label">Total Produ√ß√£o</div>
          <div class="card-value" id="dashTotalProducao">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Custos</div>
          <div class="card-value" id="dashTotalCustos">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Factura√ß√£o</div>
          <div class="card-value" id="dashTotalFacturacao">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Margem Bruta %</div>
          <div class="card-value" id="dashMargemAcumulada">0.0%</div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>Resultados Mensais e Acumulados</h3>
          <div class="table-container">
            <table class="data-table small-text">
              <thead>
                <tr>
                  <th>M√™s</th>
                  <th>Custos Mensais</th>
                  <th>Custos Acum.</th>
                  <th>Prod. Mensal</th>
                  <th>Prod. Acum.</th>
                  <th>Fact. Mensal</th>
                  <th>Fact. Acum.</th>
                  <th>Margem Mensal %</th>
                  <th>Margem Acum. %</th>
                </tr>
              </thead>
              <tbody id="monthlyResultsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>An√°lise por Categoria</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th>Contratado</th>
                  <th>Facturado</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody id="categoryAnalysisTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- DETALHES GR√ÅFICOS TAB -->
    <div id="tab-detalhes-graficos" class="tab-content">
      <div class="dashboard-grid-4">
        <div class="card dashboard-card">
          <div class="card-label">Total Custos</div>
          <div class="card-value" id="dashTotalCustos2">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Produ√ß√£o</div>
          <div class="card-value" id="dashTotalProducao2">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Total Factura√ß√£o</div>
          <div class="card-value" id="dashTotalFacturacao2">‚Ç¨0.00</div>
        </div>
        <div class="card dashboard-card">
          <div class="card-label">Margem Bruta %</div>
          <div class="card-value" id="dashMargemAcumulada2">0.0%</div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>1Ô∏è‚É£ Produ√ß√£o e Custos Mensais com Margem</h3>
          <div class="chart-container">
            <canvas id="chart1"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>2Ô∏è‚É£ Produ√ß√£o e Custos Acumulados com Margem</h3>
          <div class="chart-container">
            <canvas id="chart2"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>3Ô∏è‚É£ Factura√ß√£o vs Produ√ß√£o Mensais</h3>
          <div class="chart-container">
            <canvas id="chart3"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>4Ô∏è‚É£ Factura√ß√£o vs Produ√ß√£o Acumuladas</h3>
          <div class="chart-container">
            <canvas id="chart4"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>5Ô∏è‚É£ Distribui√ß√£o Custos Contratados por Categoria</h3>
          <div class="chart-container">
            <canvas id="chart5"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>6Ô∏è‚É£ Distribui√ß√£o Custos Incorridos por Categoria</h3>
          <div class="chart-container">
            <canvas id="chart6"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- RELAT√ìRIOS TAB -->
    <div id="tab-relatorios" class="tab-content">
      <div class="card">
        <div class="card__body">
          <h3>üìÑ Relat√≥rio Mensal</h3>
          <p style="margin-bottom: 20px; color: var(--color-text-secondary);">
            Gere um relat√≥rio completo de um m√™s espec√≠fico com todas as tabelas e gr√°ficos.
          </p>
          <div class="form-row">
            <div class="form-group">
              <label for="reportMonth" class="form-label">Selecione o M√™s *</label>
              <input type="month" id="reportMonth" class="form-control" required>
            </div>
          </div>
          <button class="btn btn--primary" onclick="generateMonthlyReport()">üì• Gerar Relat√≥rio Mensal PDF</button>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>üìä Relat√≥rio Global</h3>
          <p style="margin-bottom: 20px; color: var(--color-text-secondary);">
            Gere um relat√≥rio completo desde o in√≠cio do projeto at√© √† data atual com todas as tabelas e gr√°ficos.
          </p>
          <button class="btn btn--primary" onclick="generateGlobalReport()" style="background-color: #10b981;">üì• Gerar Relat√≥rio Global PDF</button>
        </div>
      </div>
    </div>

    <!-- IMPORTAR/EXPORTAR TAB -->
    <div id="tab-importar-exportar" class="tab-content">
      <div class="card">
        <div class="card__body">
          <h3>üì§ Exportar Base de Dados Completa</h3>
          <p>Descarregar todos os dados do projecto num ficheiro Excel com 7 folhas:</p>
          <ul style="margin: var(--space-16) 0; padding-left: var(--space-24); color: var(--color-text-secondary);">
            <li>Projeto (informa√ß√µes gerais)</li>
            <li>Contratos Adicionais</li>
            <li>Fornecedores</li>
            <li>Facturas de Custos</li>
            <li>Produ√ß√£o Mensal</li>
            <li>Facturas de Venda</li>
            <li><strong>Encomendas (com artigos)</strong></li>
          </ul>
          <button class="btn btn--primary" onclick="exportDatabase()" style="padding: var(--space-12) var(--space-24);">üì• Exportar Base de Dados</button>
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>üì• Importar Base de Dados</h3>
          <p>Carregar uma base de dados completa de um ficheiro Excel.</p>
          <p class="warning-text" style="margin-top: var(--space-8);">ATEN√á√ÉO: Todos os dados actuais ser√£o substitu√≠dos!</p>
          <button class="btn btn--secondary" onclick="document.getElementById('importDbFile').click()" style="margin-top: var(--space-16); padding: var(--space-12) var(--space-24);">
            üìÇ Seleccionar Ficheiro Excel
          </button>
          <input type="file" id="importDbFile" accept=".xlsx,.xls" style="display:none" onchange="importDatabaseFromFile()">
        </div>
      </div>

      <div class="card">
        <div class="card__body">
          <h3>üóëÔ∏è Limpar Todos os Dados</h3>
          <p class="warning-text">ATEN√á√ÉO: Esta ac√ß√£o ir√° eliminar todos os dados e n√£o pode ser revertida!</p>
          <button class="btn-danger" onclick="clearAllData()" style="margin-top: var(--space-16);">üóëÔ∏è Eliminar Todos os Dados</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL DETALHES FORNECEDOR -->
  <div id="supplierModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="supplierModalTitle" style="margin: 0; color: var(--color-primary);"></h2>
        <button onclick="closeSupplierModal()" style="background: var(--color-error); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">‚úï</button>
      </div>
      
      <!-- DADOS FORNECEDOR -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--color-border);">
        <div>
          <p style="margin: 0; color: var(--color-text-secondary); font-weight: bold; font-size: 12px;">NIF</p>
          <p id="supplierModalNIF" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 16px; font-weight: bold;"></p>
        </div>
        <div>
          <p style="margin: 0; color: var(--color-text-secondary); font-weight: bold; font-size: 12px;">CATEGORIA</p>
          <p id="supplierModalCategory" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 16px; font-weight: bold;"></p>
        </div>
        <div>
          <p style="margin: 0; color: var(--color-text-secondary); font-weight: bold; font-size: 12px;">CONTACTO</p>
          <p id="supplierModalContact" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 16px; font-weight: bold;"></p>
        </div>
        <div>
          <p style="margin: 0; color: var(--color-text-secondary); font-weight: bold; font-size: 12px;">VALOR CONTRATADO</p>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
            <input type="number" id="supplierModalContractValue" class="form-control" style="flex: 1;" step="0.01">
            <button onclick="updateSupplierContractValue()" class="btn btn--primary" style="background: var(--color-success); padding: 8px 15px;">Guardar</button>
          </div>
        </div>
      </div>
      
      <!-- FACTURAS EMITIDAS -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: var(--color-primary); margin-bottom: 15px; border-bottom: 2px solid var(--color-primary); padding-bottom: 10px;">üí∞ Facturas Emitidas</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--color-primary); color: white;">
              <th style="padding: 10px; text-align: left;">Data</th>
              <th style="padding: 10px; text-align: left;">N¬∫ Factura</th>
              <th style="padding: 10px; text-align: left;">Descri√ß√£o</th>
              <th style="padding: 10px; text-align: right;">Valor ‚Ç¨</th>
            </tr>
          </thead>
          <tbody id="supplierModalInvoices"></tbody>
        </table>
      </div>
      
      <!-- RESUMO FACTURAS VS CONTRATO -->
      <div style="background: var(--color-bg-1); padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid var(--color-primary);">
        <h3 style="color: var(--color-primary); margin-top: 0;">üìä An√°lise Facturas vs Contrato</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
          <div>
            <p style="margin: 0; color: var(--color-text-secondary); font-size: 12px; font-weight: bold;">Valor Contratado</p>
            <p id="supplierAnalysisContracted" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 18px; font-weight: bold;"></p>
          </div>
          <div>
            <p style="margin: 0; color: var(--color-text-secondary); font-size: 12px; font-weight: bold;">Total Facturado</p>
            <p id="supplierAnalysisInvoiced" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 18px; font-weight: bold;"></p>
          </div>
          <div>
            <p style="margin: 0; color: var(--color-text-secondary); font-size: 12px; font-weight: bold;">Diferen√ßa</p>
            <p id="supplierAnalysisDifference" style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;"></p>
          </div>
          <div>
            <p style="margin: 0; color: var(--color-text-secondary); font-size: 12px; font-weight: bold;">% Facturado</p>
            <p id="supplierAnalysisPercentage" style="margin: 5px 0 0 0; color: var(--color-text); font-size: 18px; font-weight: bold;"></p>
          </div>
        </div>
      </div>
      
      <!-- NOTAS DE ENCOMENDA -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: var(--color-primary); margin-bottom: 15px; border-bottom: 2px solid var(--color-primary); padding-bottom: 10px;">üìù Notas de Encomenda Emitidas</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--color-primary); color: white;">
              <th style="padding: 10px; text-align: left;">N¬∫ Encomenda</th>
              <th style="padding: 10px; text-align: left;">Data</th>
              <th style="padding: 10px; text-align: left;">Local</th>
              <th style="padding: 10px; text-align: right;">Total ‚Ç¨</th>
              <th style="padding: 10px; text-align: center;">PDF</th>
            </tr>
          </thead>
          <tbody id="supplierModalEncomendas"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="powered-by">Powered by JMD</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>
</html>